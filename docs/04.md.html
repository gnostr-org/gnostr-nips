<blockquote>
<p><strong>Warning</strong> <code>unrecommended</code>: deprecated in
favor of <a href="17.md.html">NIP-17</a></p>
</blockquote>
<h1 id="nip-04">NIP-04</h1>
<h2 id="encrypted-direct-message">Encrypted Direct Message</h2>
<p><code>final</code> <code>unrecommended</code>
<code>optional</code></p>
<p>A special event with kind <code>4</code>, meaning &#x201C;encrypted direct
message&#x201D;. It is supposed to have the following attributes:</p>
<p><strong><code>content</code></strong> MUST be equal to the
base64-encoded, aes-256-cbc encrypted string of anything a user wants to
write, encrypted using a shared cipher generated by combining the
recipient&#x2019;s public-key with the sender&#x2019;s private-key; this appended by
the base64-encoded initialization vector as if it was a querystring
parameter named &#x201C;iv&#x201D;. The format is the following:
<code>"content": "&lt;encrypted_text&gt;?iv=&lt;initialization_vector&gt;"</code>.</p>
<p><strong><code>tags</code></strong> MUST contain an entry identifying
the receiver of the message (such that relays may naturally forward this
event to them), in the form
<code>["p", "&lt;pubkey, as a hex string&gt;"]</code>.</p>
<p><strong><code>tags</code></strong> MAY contain an entry identifying
the previous message in a conversation or a message we are explicitly
replying to (such that contextual, more organized conversations may
happen), in the form <code>["e", "&lt;event_id&gt;"]</code>.</p>
<p><strong>Note</strong>: By default in the <a
href="https://github.com/bitcoin-core/secp256k1">libsecp256k1</a> ECDH
implementation, the secret is the SHA256 hash of the shared point (both
X and Y coordinates). In Nostr, only the X coordinate of the shared
point is used as the secret and it is NOT hashed. If using libsecp256k1,
a custom function that copies the X coordinate must be passed as the
<code>hashfp</code> argument in <code>secp256k1_ecdh</code>. See <a
href="https://github.com/bitcoin-core/secp256k1/blob/master/src/modules/ecdh/main_impl.h#L29">here</a>.</p>
<p>Code sample for generating such an event in JavaScript:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> crypto <span class="im">from</span> <span class="st">&#39;crypto&#39;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> secp <span class="im">from</span> <span class="st">&#39;@noble/secp256k1&#39;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sharedPoint <span class="op">=</span> secp<span class="op">.</span><span class="fu">getSharedSecret</span>(ourPrivateKey<span class="op">,</span> <span class="st">&#39;02&#39;</span> <span class="op">+</span> theirPublicKey)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sharedX <span class="op">=</span> sharedPoint<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">33</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> iv <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomFillSync</span>(<span class="kw">new</span> <span class="bu">Uint8Array</span>(<span class="dv">16</span>))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cipher <span class="op">=</span> crypto<span class="op">.</span><span class="fu">createCipheriv</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;aes-256-cbc&#39;</span><span class="op">,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(sharedX)<span class="op">,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  iv</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> encryptedMessage <span class="op">=</span> cipher<span class="op">.</span><span class="fu">update</span>(text<span class="op">,</span> <span class="st">&#39;utf8&#39;</span><span class="op">,</span> <span class="st">&#39;base64&#39;</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>encryptedMessage <span class="op">+=</span> cipher<span class="op">.</span><span class="fu">final</span>(<span class="st">&#39;base64&#39;</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ivBase64 <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(iv<span class="op">.</span><span class="at">buffer</span>)<span class="op">.</span><span class="fu">toString</span>(<span class="st">&#39;base64&#39;</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="bu">event</span> <span class="op">=</span> {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">pubkey</span><span class="op">:</span> ourPubKey<span class="op">,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">created_at</span><span class="op">:</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">/</span> <span class="dv">1000</span>)<span class="op">,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">kind</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tags</span><span class="op">:</span> [[<span class="st">&#39;p&#39;</span><span class="op">,</span> theirPublicKey]]<span class="op">,</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">content</span><span class="op">:</span> encryptedMessage <span class="op">+</span> <span class="st">&#39;?iv=&#39;</span> <span class="op">+</span> ivBase64</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="security-warning">Security Warning</h2>
<p>This standard does not go anywhere near what is considered the
state-of-the-art in encrypted communication between peers, and it leaks
metadata in the events, therefore it must not be used for anything you
really need to keep secret, and only with relays that use
<code>AUTH</code> to restrict who can fetch your <code>kind:4</code>
events.</p>
<h2 id="client-implementation-warning">Client Implementation
Warning</h2>
<p>Clients <em>should not</em> search and replace public key or note
references from the <code>.content</code>. If processed like a regular
text note (where <code>@npub...</code> is replaced with
<code>#[0]</code> with a <code>["p", "..."]</code> tag) the tags are
leaked and the mentioned user will receive the message in their
inbox.</p>
