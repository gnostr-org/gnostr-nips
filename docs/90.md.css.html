<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>90</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="nip-90">NIP-90</h1>
<h2 id="data-vending-machine">Data Vending Machine</h2>
<p><code>draft</code> <code>optional</code></p>
<p>This NIP defines the interaction between customers and Service
Providers for performing on-demand computation.</p>
<p>Money in, data out.</p>
<h2 id="kinds">Kinds</h2>
<p>This NIP reserves the range <code>5000-7000</code> for data vending
machine use.</p>
<table>
<thead>
<tr>
<th>Kind</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>5000-5999</td>
<td>Job request kinds</td>
</tr>
<tr>
<td>6000-6999</td>
<td>Job result</td>
</tr>
<tr>
<td>7000</td>
<td>Job feedback</td>
</tr>
</tbody>
</table>
<p>Job results always use a kind number that is <code>1000</code> higher
than the job request kind. (e.g. request: <code>kind:5001</code> gets a
result: <code>kind:6001</code>).</p>
<p>Job request types are defined <a
href="https://github.com/nostr-protocol/data-vending-machines/tree/master/kinds">separately</a>.</p>
<h2 id="rationale">Rationale</h2>
<p>Nostr can act as a marketplace for data processing, where users
request jobs to be processed in certain ways (e.g., “speech-to-text”,
“summarization”, etc.), but they don’t necessarily care about “who”
processes the data.</p>
<p>This NIP is not to be confused with a 1:1 marketplace; instead, it
describes a flow where a user announces a desired output, willingness to
pay, and service providers compete to fulfill the job requirement in the
best way possible.</p>
<h3 id="actors">Actors</h3>
<p>There are two actors in the workflow described in this NIP: *
Customers (npubs who request a job) * Service providers (npubs who
fulfill jobs)</p>
<h2 id="job-request-kind5000-5999">Job request
(<code>kind:5000-5999</code>)</h2>
<p>A request to process data, published by a customer. This event
signals that a customer is interested in receiving the result of some
kind of compute.</p>
<pre class="jsonc"><code>{
    &quot;kind&quot;: 5xxx, // kind in 5000-5999 range
    &quot;content&quot;: &quot;&quot;,
    &quot;tags&quot;: [
        [ &quot;i&quot;, &quot;&lt;data&gt;&quot;, &quot;&lt;input-type&gt;&quot;, &quot;&lt;relay&gt;&quot;, &quot;&lt;marker&gt;&quot; ],
        [ &quot;output&quot;, &quot;&lt;mime-type&gt;&quot; ],
        [ &quot;relays&quot;, &quot;wss://...&quot; ],
        [ &quot;bid&quot;, &quot;&lt;msat-amount&gt;&quot; ],
        [ &quot;t&quot;, &quot;bitcoin&quot; ]
    ],
    // other fields...
}</code></pre>
<p>All tags are optional.</p>
<ul>
<li><code>i</code> tag: Input data for the job (zero or more inputs)
<ul>
<li><code>&lt;data&gt;</code>: The argument for the input</li>
<li><code>&lt;input-type&gt;</code>: The way this argument should be
interpreted. MUST be one of:
<ul>
<li><code>url</code>: A URL to be fetched of the data that should be
processed.</li>
<li><code>event</code>: A Nostr event ID.</li>
<li><code>job</code>: The output of a previous job with the specified
event ID. The dermination of which output to build upon is up to the
service provider to decide (e.g. waiting for a signaling from the
customer, waiting for a payment, etc.)</li>
<li><code>text</code>: <code>&lt;data&gt;</code> is the value of the
input, no resolution is needed</li>
</ul></li>
<li><code>&lt;relay&gt;</code>: If <code>event</code> or
<code>job</code> input-type, the relay where the event/job was
published, otherwise optional or empty string</li>
<li><code>&lt;marker&gt;</code>: An optional field indicating how this
input should be used within the context of the job</li>
</ul></li>
<li><code>output</code>: Expected output format. Different job request
<code>kind</code> defines this more precisely.</li>
<li><code>param</code>: Optional parameters for the job as key (first
argument)/value (second argument). Different job request
<code>kind</code> defines this more precisely.
(e.g. <code>[ "param", "lang", "es" ]</code>)</li>
<li><code>bid</code>: Customer MAY specify a maximum amount (in
millisats) they are willing to pay</li>
<li><code>relays</code>: List of relays where Service Providers SHOULD
publish responses to</li>
<li><code>p</code>: Service Providers the customer is interested in.
Other SPs MIGHT still choose to process the job</li>
</ul>
<h2 id="encrypted-params">Encrypted Params</h2>
<p>If the user wants to keep the input parameters a secret, they can
encrypt the <code>i</code> and <code>param</code> tags with the service
provider’s ‘p’ tag and add it to the content field. Add a tag
<code>encrypted</code> as tags. Encryption for private tags will use <a
href="https://github.com/nostr-protocol/nips/blob/master/04.md.css.html">NIP-04 -
Encrypted Direct Message encryption</a>, using the user’s private and
service provider’s public key for the shared secret</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">[</span><span class="st">&quot;i&quot;</span><span class="ot">,</span> <span class="st">&quot;what is the capital of France? &quot;</span><span class="ot">,</span> <span class="st">&quot;text&quot;</span><span class="ot">],</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">[</span><span class="st">&quot;param&quot;</span><span class="ot">,</span> <span class="st">&quot;model&quot;</span><span class="ot">,</span> <span class="st">&quot;LLaMA-2&quot;</span><span class="ot">],</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">[</span><span class="st">&quot;param&quot;</span><span class="ot">,</span> <span class="st">&quot;max_tokens&quot;</span><span class="ot">,</span> <span class="st">&quot;512&quot;</span><span class="ot">],</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">[</span><span class="st">&quot;param&quot;</span><span class="ot">,</span> <span class="st">&quot;temperature&quot;</span><span class="ot">,</span> <span class="st">&quot;0.5&quot;</span><span class="ot">],</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">[</span><span class="st">&quot;param&quot;</span><span class="ot">,</span> <span class="st">&quot;top-k&quot;</span><span class="ot">,</span> <span class="st">&quot;50&quot;</span><span class="ot">],</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">[</span><span class="st">&quot;param&quot;</span><span class="ot">,</span> <span class="st">&quot;top-p&quot;</span><span class="ot">,</span> <span class="st">&quot;0.7&quot;</span><span class="ot">],</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">[</span><span class="st">&quot;param&quot;</span><span class="ot">,</span> <span class="st">&quot;frequency_penalty&quot;</span><span class="ot">,</span> <span class="st">&quot;1&quot;</span><span class="ot">]</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div>
<p>This param data will be encrypted and added to the
<code>content</code> field and <code>p</code> tag should be present</p>
<pre class="jsonc"><code>{
  &quot;content&quot;: &quot;BE2Y4xvS6HIY7TozIgbEl3sAHkdZoXyLRRkZv4fLPh3R7LtviLKAJM5qpkC7D6VtMbgIt4iNcMpLtpo...&quot;,
  &quot;tags&quot;: [
    [&quot;p&quot;, &quot;04f74530a6ede6b24731b976b8e78fb449ea61f40ff10e3d869a3030c4edc91f&quot;],
    [&quot;encrypted&quot;]
  ],
  // other fields...
}</code></pre>
<h2 id="job-result-kind6000-6999">Job result
(<code>kind:6000-6999</code>)</h2>
<p>Service providers publish job results, providing the output of the
job result. They should tag the original job request event id as well as
the customer’s pubkey.</p>
<pre class="jsonc"><code>{
  &quot;pubkey&quot;: &quot;&lt;service-provider pubkey&gt;&quot;,
  &quot;content&quot;: &quot;&lt;payload&gt;&quot;,
  &quot;kind&quot;: 6xxx,
  &quot;tags&quot;: [
    [&quot;request&quot;, &quot;&lt;job-request&gt;&quot;],
    [&quot;e&quot;, &quot;&lt;job-request-id&gt;&quot;, &quot;&lt;relay-hint&gt;&quot;],
    [&quot;i&quot;, &quot;&lt;input-data&gt;&quot;],
    [&quot;p&quot;, &quot;&lt;customer&#39;s-pubkey&gt;&quot;],
    [&quot;amount&quot;, &quot;requested-payment-amount&quot;, &quot;&lt;optional-bolt11&gt;&quot;]
  ],
  // other fields...
}</code></pre>
<ul>
<li><code>request</code>: The job request event stringified-JSON.</li>
<li><code>amount</code>: millisats that the Service Provider is
requesting to be paid. An optional third value can be a bolt11
invoice.</li>
<li><code>i</code>: The original input(s) specified in the request.</li>
</ul>
<h2 id="encrypted-output">Encrypted Output</h2>
<p>If the request has encrypted params, then output should be encrypted
and placed in <code>content</code> field. If the output is encrypted,
then avoid including <code>i</code> tag with input-data as clear text.
Add a tag encrypted to mark the output content as
<code>encrypted</code></p>
<pre class="jsonc"><code>{
  &quot;pubkey&quot;: &quot;&lt;service-provider pubkey&gt;&quot;,
  &quot;content&quot;: &quot;&lt;encrypted payload&gt;&quot;,
  &quot;kind&quot;: 6xxx,
  &quot;tags&quot;: [
    [&quot;request&quot;, &quot;&lt;job-request&gt;&quot;],
    [&quot;e&quot;, &quot;&lt;job-request-id&gt;&quot;, &quot;&lt;relay-hint&gt;&quot;],
    [&quot;p&quot;, &quot;&lt;customer&#39;s-pubkey&gt;&quot;],
    [&quot;amount&quot;, &quot;requested-payment-amount&quot;, &quot;&lt;optional-bolt11&gt;&quot;],
    [&quot;encrypted&quot;]
  ],
  // other fields...
}</code></pre>
<h2 id="job-feedback">Job feedback</h2>
<p>Service providers can give feedback about a job back to the
customer.</p>
<pre class="jsonc"><code>{
  &quot;kind&quot;: 7000,
  &quot;content&quot;: &quot;&lt;empty-or-payload&gt;&quot;,
  &quot;tags&quot;: [
    [&quot;status&quot;, &quot;&lt;status&gt;&quot;, &quot;&lt;extra-info&gt;&quot;],
    [&quot;amount&quot;, &quot;requested-payment-amount&quot;, &quot;&lt;bolt11&gt;&quot;],
    [&quot;e&quot;, &quot;&lt;job-request-id&gt;&quot;, &quot;&lt;relay-hint&gt;&quot;],
    [&quot;p&quot;, &quot;&lt;customer&#39;s-pubkey&gt;&quot;],
  ],
  // other fields...
}</code></pre>
<ul>
<li><p><code>content</code>: Either empty or a job-result (e.g. for
partial-result samples)</p></li>
<li><p><code>amount</code> tag: as defined in the <a
href="#job-result-kind6000-6999">Job Result</a> section.</p></li>
<li><p><code>status</code> tag: Service Providers SHOULD indicate what
this feedback status refers to. <a href="#job-feedback-status">Job
Feedback Status</a> defines status. Extra human-readable information can
be added as an extra argument.</p></li>
<li><p>NOTE: If the input params requires input to be encrypted, then
<code>content</code> field will have encrypted payload with
<code>p</code> tag as key.</p></li>
</ul>
<h3 id="job-feedback-status">Job feedback status</h3>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr>
<th>status</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>payment-required</code></td>
<td>Service Provider requires payment before continuing.</td>
</tr>
<tr>
<td><code>processing</code></td>
<td>Service Provider is processing the job.</td>
</tr>
<tr>
<td><code>error</code></td>
<td>Service Provider was unable to process the job.</td>
</tr>
<tr>
<td><code>success</code></td>
<td>Service Provider successfully processed the job.</td>
</tr>
<tr>
<td><code>partial</code></td>
<td>Service Provider partially processed the job. The
<code>.content</code> might include a sample of the partial
results.</td>
</tr>
</tbody>
</table>
<p>Any job feedback event MIGHT include results in the
<code>.content</code> field, as described in the <a
href="#job-result-kind6000-6999">Job Result</a> section. This is useful
for service providers to provide a sample of the results that have been
processed so far.</p>
<h1 id="protocol-flow">Protocol Flow</h1>
<ul>
<li>Customer publishes a job request (e.g. <code>kind:5000</code>
speech-to-text).</li>
<li>Service Providers MAY submit <code>kind:7000</code> job-feedback
events (e.g. <code>payment-required</code>, <code>processing</code>,
<code>error</code>, etc.).</li>
<li>Upon completion, the service provider publishes the result of the
job with a <code>kind:6000</code> job-result event.</li>
<li>At any point, if there is an <code>amount</code> pending to be paid
as instructed by the service provider, the user can pay the included
<code>bolt11</code> or zap the job result event the service provider has
sent to the user</li>
</ul>
<p>Job feedback (<code>kind:7000</code>) and Job Results
(<code>kind:6000-6999</code>) events MAY include an <code>amount</code>
tag, this can be interpreted as a suggestion to pay. Service Providers
MUST use the <code>payment-required</code> feedback event to signal that
a payment is required and no further actions will be performed until the
payment is sent.</p>
<p>Customers can always either pay the included <code>bolt11</code>
invoice or zap the event requesting the payment and service providers
should monitor for both if they choose to include a bolt11 invoice.</p>
<h2 id="notes-about-the-protocol-flow">Notes about the protocol
flow</h2>
<p>The flow is deliberately ambiguous, allowing vast flexibility for the
interaction between customers and service providers so that service
providers can model their behavior based on their own
decisions/perceptions of risk.</p>
<p>Some service providers might choose to submit a
<code>payment-required</code> as the first reaction before sending a
<code>processing</code> or before delivering results, some might choose
to serve partial results for the job (e.g. a sample), send a
<code>payment-required</code> to deliver the rest of the results, and
some service providers might choose to assess likelihood of payment
based on an npub’s past behavior and thus serve the job results before
requesting payment for the best possible UX.</p>
<p>It’s not up to this NIP to define how individual vending machines
should choose to run their business.</p>
<h1 id="cancellation">Cancellation</h1>
<p>A job request might be canceled by publishing a <code>kind:5</code>
delete request event tagging the job request event.</p>
<h1 id="appendix-1-job-chaining">Appendix 1: Job chaining</h1>
<p>A Customer MAY request multiple jobs to be processed as a chain,
where the output of a job is the input of another job. (e.g. podcast
transcription -&gt; summarization of the transcription). This is done by
specifying as input an event id of a different job with the
<code>job</code> type.</p>
<p>Service Providers MAY begin processing a subsequent job the moment
they see the prior job’s result, but they will likely wait for a zap to
be published first. This introduces a risk that Service Provider of job
#1 might delay publishing the zap event in order to have an advantage.
This risk is up to Service Providers to mitigate or to decide whether
the service provider of job #1 tends to have good-enough results so as
to not wait for an explicit zap to assume the job was accepted.</p>
<p>This gives a higher level of flexibility to service providers (which
sophisticated service providers would take anyway).</p>
<h1 id="appendix-2-service-provider-discoverability">Appendix 2: Service
provider discoverability</h1>
<p>Service Providers MAY use NIP-89 announcements to advertise their
support for job kinds:</p>
<pre class="jsonc"><code>{
  &quot;kind&quot;: 31990,
  &quot;pubkey&quot;: &quot;&lt;pubkey&gt;&quot;,
  &quot;content&quot;: &quot;{
    \&quot;name\&quot;: \&quot;Translating DVM\&quot;,
    \&quot;about\&quot;: \&quot;I&#39;m a DVM specialized in translating Bitcoin content.\&quot;
  }&quot;,
  &quot;tags&quot;: [
    [&quot;k&quot;, &quot;5005&quot;], // e.g. translation
    [&quot;t&quot;, &quot;bitcoin&quot;] // e.g. optionally advertises it specializes in bitcoin audio transcription that won&#39;t confuse &quot;Drivechains&quot; with &quot;Ridechains&quot;
  ],
  // other fields...
}</code></pre>
<p>Customers can use NIP-89 to see what service providers their follows
use.</p>
</body>
</html>
